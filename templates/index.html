<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LCU Companion</title>
    <link rel="icon" type="image/x-icon" href="/static/icon.ico" />

    <!-- Ant Design Vue CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/ant-design-vue@4.x/dist/reset.css"
    />
    <!-- Bootstrap Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --bg-color: #0a0a0f;
        --card-bg: rgba(255, 255, 255, 0.05);
        --text-primary: #ffffff;
        --text-secondary: rgba(255, 255, 255, 0.6);
        --accent-color: #1668dc;
        --success-color: #52c41a;
        --danger-color: #ff4d4f;
        --warning-color: #faad14;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        background: var(--bg-color);
        background-image: radial-gradient(
            at 0% 0%,
            rgba(22, 104, 220, 0.15) 0px,
            transparent 50%
          ),
          radial-gradient(
            at 100% 0%,
            rgba(82, 196, 26, 0.1) 0px,
            transparent 50%
          ),
          radial-gradient(
            at 100% 100%,
            rgba(255, 77, 79, 0.1) 0px,
            transparent 50%
          ),
          radial-gradient(
            at 0% 100%,
            rgba(250, 173, 20, 0.1) 0px,
            transparent 50%
          );
        background-attachment: fixed;
        color: var(--text-primary);
        font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
        min-height: 100vh;
      }

      [v-cloak] {
        display: none;
      }

      /* Ant Design Dark Theme Overrides */
      .ant-layout {
        background: transparent !important;
      }
      .ant-layout-sider {
        background: rgba(15, 15, 25, 0.8) !important;
        backdrop-filter: blur(20px);
        border-right: 1px solid rgba(255, 255, 255, 0.06);
      }
      .ant-menu-dark {
        background: transparent !important;
      }
      .ant-menu-dark .ant-menu-item {
        margin: 8px;
        border-radius: 12px;
      }
      .ant-menu-dark .ant-menu-item-selected {
        background: rgba(22, 104, 220, 0.3) !important;
      }
      .ant-card {
        background: rgba(255, 255, 255, 0.03) !important;
        border: 1px solid rgba(255, 255, 255, 0.06) !important;
        border-radius: 16px !important;
        backdrop-filter: blur(10px);
      }
      .ant-card-head {
        border-bottom: 1px solid rgba(255, 255, 255, 0.06) !important;
        color: var(--text-primary) !important;
      }
      .ant-card-head-title {
        color: var(--text-primary) !important;
      }
      .ant-card-body {
        color: var(--text-secondary);
      }
      .ant-input {
        background: rgba(0, 0, 0, 0.2) !important;
        border: 1px solid rgba(255, 255, 255, 0.1) !important;
        color: white !important;
        border-radius: 10px !important;
      }
      .ant-input::placeholder {
        color: rgba(255, 255, 255, 0.4) !important;
      }
      .ant-input:focus,
      .ant-input:hover {
        border-color: var(--accent-color) !important;
      }
      .ant-btn-primary {
        background: linear-gradient(
          135deg,
          #1668dc 0%,
          #1554ad 100%
        ) !important;
        border: none !important;
        box-shadow: 0 4px 15px rgba(22, 104, 220, 0.3) !important;
      }
      .ant-btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 20px rgba(22, 104, 220, 0.4) !important;
      }
      .ant-btn-default {
        background: rgba(255, 255, 255, 0.05) !important;
        border: 1px solid rgba(255, 255, 255, 0.1) !important;
        color: white !important;
      }
      .ant-tag {
        border-radius: 6px !important;
      }
      .ant-switch-checked {
        background: var(--success-color) !important;
      }
      .ant-select-selector {
        background: rgba(0, 0, 0, 0.2) !important;
        border: 1px solid rgba(255, 255, 255, 0.1) !important;
        border-radius: 10px !important;
      }
      .ant-select-selection-item,
      .ant-select-selection-placeholder {
        color: rgba(255, 255, 255, 0.6) !important;
      }
      .ant-collapse-header {
        color: var(--text-secondary) !important;
      }

      /* Custom Components */
      .app-container {
        display: flex;
        min-height: 100vh;
      }
      .main-content {
        flex: 1;
        padding: 24px;
        margin-left: 80px;
      }
      .header-section {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
      }
      .status-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        background: rgba(82, 196, 26, 0.1);
        border: 1px solid rgba(82, 196, 26, 0.2);
        border-radius: 20px;
        color: #52c41a;
        font-weight: 500;
      }
      .status-indicator.disconnected {
        background: rgba(255, 77, 79, 0.1);
        border-color: rgba(255, 77, 79, 0.2);
        color: #ff4d4f;
      }
      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: currentColor;
        box-shadow: 0 0 10px currentColor;
      }
      .dashboard-grid {
        display: grid;
        grid-template-columns: 1fr 1.5fr;
        gap: 24px;
      }
      .module-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 16px;
        margin-bottom: 20px;
      }
      .module-card {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: 16px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      .module-card:hover {
        background: rgba(255, 255, 255, 0.06);
        transform: translateY(-2px);
      }
      .module-card.active {
        border-color: rgba(82, 196, 26, 0.4);
        box-shadow: 0 0 20px rgba(82, 196, 26, 0.1);
      }
      .module-card .icon {
        font-size: 28px;
        margin-bottom: 12px;
        color: var(--accent-color);
      }
      .module-card.active .icon {
        color: var(--success-color);
      }
      .module-card .title {
        font-weight: 600;
        margin-bottom: 4px;
        color: var(--text-primary);
      }
      .module-card .status {
        font-size: 12px;
        color: var(--text-secondary);
      }
      .analysis-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
      }
      .analysis-card {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: 16px;
        padding: 20px;
      }
      .analysis-card .header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 16px;
      }
      .analysis-card .header .icon {
        font-size: 24px;
      }
      .activity-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: rgba(255, 255, 255, 0.02);
        border-radius: 10px;
        margin-bottom: 8px;
      }
      .victory-badge {
        background: rgba(82, 196, 26, 0.2);
        color: #52c41a;
        padding: 4px 12px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
      }
      .defeat-badge {
        background: rgba(255, 77, 79, 0.2);
        color: #ff4d4f;
        padding: 4px 12px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
      }

      /* Dynamic Island */
      .dynamic-island {
        position: fixed;
        top: 16px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 24px;
        padding: 8px 20px;
        display: flex;
        align-items: center;
        gap: 10px;
        z-index: 1000;
      }
      .dynamic-island .icon {
        color: var(--accent-color);
      }
      .dynamic-island .text {
        color: var(--text-secondary);
        font-size: 14px;
      }

      @media (max-width: 1200px) {
        .dashboard-grid {
          grid-template-columns: 1fr;
        }
        .module-grid {
          grid-template-columns: repeat(2, 1fr);
        }
      }
      @media (max-width: 768px) {
        .main-content {
          margin-left: 0;
          padding: 16px;
        }
        .module-grid,
        .analysis-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    {% raw %}
    <div id="app" v-cloak>
      <!-- Dynamic Island -->
      <div class="dynamic-island">
        <i class="bi bi-activity icon"></i>
        <span class="text">{{ realtimeStatus }}</span>
      </div>

      <a-config-provider :theme="darkTheme">
        <a-layout class="app-container">
          <!-- Sidebar -->
          <a-layout-sider
            :width="80"
            :collapsed="true"
            :trigger="null"
            style="
              position: fixed;
              height: 100vh;
              left: 0;
              top: 0;
              z-index: 100;
            "
          >
            <div style="padding: 20px; text-align: center">
              <i
                class="bi bi-lightning-charge-fill"
                style="font-size: 28px; color: #1668dc"
              ></i>
            </div>
            <a-menu
              v-model:selectedKeys="selectedNav"
              theme="dark"
              mode="inline"
            >
              <a-menu-item key="dashboard" @click="navigateTo('dashboard')">
                <template #icon><i class="bi bi-house-door"></i></template>
              </a-menu-item>
              <a-menu-item key="search" @click="navigateTo('search')">
                <template #icon><i class="bi bi-search"></i></template>
              </a-menu-item>
              <a-menu-item key="automation" @click="navigateTo('automation')">
                <template #icon><i class="bi bi-cpu"></i></template>
              </a-menu-item>
              <a-menu-item key="stats" @click="navigateTo('stats')">
                <template #icon><i class="bi bi-bar-chart"></i></template>
              </a-menu-item>
            </a-menu>
            <div style="flex-grow: 1"></div>
            <a-menu theme="dark" mode="inline" style="margin-top: auto">
              <a-menu-item key="settings">
                <template #icon><i class="bi bi-gear"></i></template>
              </a-menu-item>
            </a-menu>
          </a-layout-sider>

          <!-- Main Content -->
          <a-layout-content class="main-content">
            <!-- Header -->
            <div class="header-section">
              <div>
                <h1
                  style="font-size: 28px; font-weight: 700; margin-bottom: 4px"
                >
                  Dashboard
                </h1>
                <span style="color: var(--text-secondary)"
                  >Welcome back, {{ summonerName }}</span
                >
              </div>
              <div
                :class="['status-indicator', { disconnected: !lcuConnected }]"
              >
                <div class="status-dot"></div>
                <span
                  >{{ lcuConnected ? 'LCU Connected' : 'LCU Disconnected'
                  }}</span
                >
              </div>
            </div>

            <!-- Dashboard Grid -->
            <div class="dashboard-grid">
              <!-- Left Column -->
              <div class="left-column">
                <!-- Search Card -->
                <a-card style="margin-bottom: 20px">
                  <template #title>
                    <i
                      class="bi bi-search"
                      style="margin-right: 8px; color: #1668dc"
                    ></i>
                    Summoner Search
                  </template>
                  <a-input-search
                    v-model:value="searchName"
                    placeholder="Summoner Name#Tag..."
                    enter-button="Search"
                    size="large"
                    @search="searchSummoner"
                    style="margin-bottom: 12px"
                  />
                  <a-button block @click="searchTFT" style="margin-top: 8px">
                    <i class="bi bi-grid-3x3-gap" style="margin-right: 8px"></i>
                    TFT Stats
                  </a-button>
                </a-card>

                <!-- Recent Activity -->
                <a-card>
                  <template #title>
                    <i
                      class="bi bi-activity"
                      style="margin-right: 8px; color: #1668dc"
                    ></i>
                    Recent Activity
                  </template>
                  <template v-if="lcuConnected && recentGames.length > 0">
                    <div
                      v-for="(game, idx) in recentGames"
                      :key="idx"
                      class="activity-item"
                    >
                      <span
                        :class="game.win ? 'victory-badge' : 'defeat-badge'"
                      >
                        {{ game.win ? 'Victory' : 'Defeat' }}
                      </span>
                      <div>
                        <div
                          style="font-weight: 600; color: var(--text-primary)"
                        >
                          {{ game.queue_name }}
                        </div>
                        <div
                          style="font-size: 12px; color: var(--text-secondary)"
                        >
                          {{ game.time_ago }}
                        </div>
                      </div>
                    </div>
                  </template>
                  <a-empty
                    v-else-if="lcuConnected"
                    description="No recent games found"
                  ></a-empty>
                  <a-empty v-else description="Connect to LCU to view activity">
                    <template #image>
                      <i
                        class="bi bi-wifi-off"
                        style="font-size: 48px; color: var(--text-secondary)"
                      ></i>
                    </template>
                  </a-empty>
                </a-card>
              </div>

              <!-- Right Column -->
              <div class="right-column">
                <!-- Automation Hub -->
                <a-card style="margin-bottom: 20px">
                  <template #title>
                    <div
                      style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                      "
                    >
                      <span>
                        <i
                          class="bi bi-lightning-charge"
                          style="margin-right: 8px; color: #faad14"
                        ></i>
                        Automation Hub
                      </span>
                      <a-tag color="blue"
                        >{{ activeModulesCount }} Active</a-tag
                      >
                    </div>
                  </template>

                  <div class="module-grid">
                    <!-- Auto Accept -->
                    <div
                      :class="['module-card', { active: autoAcceptRunning }]"
                      @click="toggleAutoAccept"
                    >
                      <i class="bi bi-check-circle icon"></i>
                      <div class="title">Auto Accept</div>
                      <div class="status">
                        {{ autoAcceptRunning ? 'Running' : 'Ready' }}
                      </div>
                      <a-switch
                        :checked="autoAcceptRunning"
                        size="small"
                        style="margin-top: 8px"
                        @click.stop
                      />
                    </div>

                    <!-- Auto Analyze -->
                    <div
                      :class="['module-card', { active: autoAnalyzeRunning }]"
                      @click="toggleAutoAnalyze"
                    >
                      <i class="bi bi-shield-check icon"></i>
                      <div class="title">Analyze Enemy</div>
                      <div class="status">
                        {{ autoAnalyzeRunning ? 'Analyzing' : 'Waiting' }}
                      </div>
                      <a-switch
                        :checked="autoAnalyzeRunning"
                        size="small"
                        style="margin-top: 8px"
                        @click.stop
                      />
                    </div>

                    <!-- Auto Ban/Pick -->
                    <div
                      :class="['module-card', { active: autoBanPickRunning }]"
                      @click="toggleAutoBanPick"
                    >
                      <i class="bi bi-tools icon"></i>
                      <div class="title">Auto Ban/Pick</div>
                      <div class="status">
                        {{ autoBanPickRunning ? 'Active' : 'Configured' }}
                      </div>
                      <a-switch
                        :checked="autoBanPickRunning"
                        size="small"
                        style="margin-top: 8px"
                        @click.stop
                      />
                    </div>
                  </div>

                  <!-- Ban/Pick Config -->
                  <a-collapse ghost>
                    <a-collapse-panel key="1" header="Ban/Pick Configuration">
                      <a-row :gutter="16">
                        <a-col :span="12">
                          <div
                            style="
                              margin-bottom: 8px;
                              color: var(--text-secondary);
                              font-size: 12px;
                            "
                          >
                            BAN PRIORITY
                          </div>
                          <a-select
                            v-for="(ban, index) in banChampions"
                            :key="'ban-' + index"
                            v-model:value="banChampions[index]"
                            :options="championOptions"
                            placeholder="Select champion"
                            style="width: 100%; margin-bottom: 8px"
                            show-search
                            :filter-option="filterChampion"
                            allow-clear
                          />
                          <a-button
                            type="dashed"
                            block
                            @click="addBanSlot"
                            size="small"
                          >
                            <i class="bi bi-plus"></i> Add Ban
                          </a-button>
                        </a-col>
                        <a-col :span="12">
                          <div
                            style="
                              margin-bottom: 8px;
                              color: var(--text-secondary);
                              font-size: 12px;
                            "
                          >
                            PICK PRIORITY
                          </div>
                          <a-select
                            v-for="(pick, index) in pickChampions"
                            :key="'pick-' + index"
                            v-model:value="pickChampions[index]"
                            :options="championOptions"
                            placeholder="Select champion"
                            style="width: 100%; margin-bottom: 8px"
                            show-search
                            :filter-option="filterChampion"
                            allow-clear
                          />
                          <a-button
                            type="dashed"
                            block
                            @click="addPickSlot"
                            size="small"
                          >
                            <i class="bi bi-plus"></i> Add Pick
                          </a-button>
                        </a-col>
                      </a-row>
                    </a-collapse-panel>
                  </a-collapse>
                </a-card>

                <!-- Analysis Cards -->
                <div class="analysis-grid">
                  <div class="analysis-card">
                    <div class="header">
                      <i
                        class="bi bi-shield-fill icon"
                        style="color: #1668dc"
                      ></i>
                      <div>
                        <div style="font-weight: 600">Teammate Analysis</div>
                        <div
                          style="font-size: 12px; color: var(--text-secondary)"
                        >
                          View detailed stats
                        </div>
                      </div>
                    </div>
                    <a-empty
                      v-if="teammates.length === 0"
                      description="Waiting for game..."
                      :image-style="{ height: '40px' }"
                    ></a-empty>
                    <div v-else>
                      <div
                        v-for="tm in teammates"
                        :key="tm.puuid"
                        class="activity-item"
                      >
                        <a-avatar style="background-color: #1668dc"
                          >{{ tm.gameName.charAt(0) }}</a-avatar
                        >
                        <div style="flex: 1">
                          <a
                            :href="'/summoner/' + encodeURIComponent(tm.gameName + '#' + tm.tagLine)"
                            target="_blank"
                            style="color: #1668dc; font-weight: 600"
                          >
                            {{ tm.gameName }}#{{ tm.tagLine }}
                          </a>
                          <div
                            style="
                              font-size: 12px;
                              color: var(--text-secondary);
                            "
                          >
                            {{ tm.stats || 'Loading...' }}
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="analysis-card">
                    <div class="header">
                      <i
                        class="bi bi-crosshair icon"
                        style="color: #ff4d4f"
                      ></i>
                      <div>
                        <div style="font-weight: 600">Enemy Analysis</div>
                        <div
                          style="font-size: 12px; color: var(--text-secondary)"
                        >
                          Identify threats
                        </div>
                      </div>
                    </div>
                    <a-empty
                      v-if="enemies.length === 0"
                      description="Waiting for game..."
                      :image-style="{ height: '40px' }"
                    ></a-empty>
                    <div v-else>
                      <div
                        v-for="enemy in enemies"
                        :key="enemy.puuid"
                        class="activity-item"
                      >
                        <a-avatar style="background-color: #ff4d4f"
                          >{{ enemy.gameName.charAt(0) }}</a-avatar
                        >
                        <div style="flex: 1">
                          <a
                            :href="'/summoner/' + encodeURIComponent(enemy.gameName + '#' + enemy.tagLine)"
                            target="_blank"
                            style="color: #ff4d4f; font-weight: 600"
                          >
                            {{ enemy.gameName }}#{{ enemy.tagLine }}
                          </a>
                          <div
                            style="
                              font-size: 12px;
                              color: var(--text-secondary);
                            "
                          >
                            {{ enemy.stats || 'Loading...' }}
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </a-layout-content>
        </a-layout>
      </a-config-provider>
    </div>
    {% endraw %}

    <!-- Loading Overlay -->
    <div
      id="loading-overlay"
      style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #0a0a0f;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        color: white;
        transition: opacity 0.5s;
      "
    >
      <div style="font-size: 24px; margin-bottom: 20px">
        Loading LCU Companion...
      </div>
      <div
        class="spinner-border text-primary"
        role="status"
        style="width: 3rem; height: 3rem"
      >
        <span class="visually-hidden">Loading...</span>
      </div>
      <div
        id="loading-error"
        style="
          margin-top: 20px;
          color: #ff4d4f;
          display: none;
          text-align: center;
          max-width: 80%;
        "
      ></div>
      <div
        id="loading-debug"
        style="
          margin-top: 10px;
          color: #666;
          font-family: monospace;
          font-size: 12px;
        "
      ></div>
    </div>

    <script id="vue-initial-data" type="application/json">
      {{ initial_vue_data | tojson | safe }}
    </script>

    <!-- Error Handling & Resource Loading -->
    <script>
      window.loadErrors = [];
      window.onerror = function (msg, url, line, col, error) {
        console.error("Global Error:", msg, url, line, col, error);
        window.loadErrors.push({ msg, url, line, col, error });
        document.getElementById("loading-error").style.display = "block";
        document.getElementById(
          "loading-error"
        ).innerHTML += `<div>Error: ${msg}</div>`;
      };

      function checkResource(name) {
        document.getElementById(
          "loading-debug"
        ).innerHTML += `<div>Loaded ${name}</div>`;
      }

      function resourceError(name, url) {
        console.error(`Failed to load ${name} from ${url}`);
        document.getElementById("loading-error").style.display = "block";
        document.getElementById("loading-error").innerHTML += `
                <div style="margin-bottom: 10px;">
                    <strong>Failed to load ${name}</strong><br>
                    <small>${url}</small><br>
                    Please check your internet connection or try refreshing.
                </div>
            `;
      }
    </script>

    <!-- Vue 3 + Ant Design Vue -->
    <script
      src="https://cdn.jsdelivr.net/npm/vue@3.4/dist/vue.global.prod.js"
      crossorigin="anonymous"
      onload="checkResource('Vue')"
      onerror="resourceError('Vue', this.src)"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/dayjs@1.11/dayjs.min.js"
      crossorigin="anonymous"
      onload="checkResource('Dayjs')"
      onerror="resourceError('Dayjs', this.src)"
    ></script>

    <!-- Day.js Plugins -->
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11/plugin/customParseFormat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11/plugin/weekday.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11/plugin/localeData.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11/plugin/weekOfYear.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11/plugin/weekYear.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11/plugin/advancedFormat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11/plugin/quarterOfYear.js"></script>

    <script>
      // Initialize Day.js plugins
      if (window.dayjs) {
        dayjs.extend(window.dayjs_plugin_customParseFormat);
        dayjs.extend(window.dayjs_plugin_weekday);
        dayjs.extend(window.dayjs_plugin_localeData);
        dayjs.extend(window.dayjs_plugin_weekOfYear);
        dayjs.extend(window.dayjs_plugin_weekYear);
        dayjs.extend(window.dayjs_plugin_advancedFormat);
        dayjs.extend(window.dayjs_plugin_quarterOfYear);
      }
    </script>

    <script
      src="https://cdn.jsdelivr.net/npm/ant-design-vue@4.x/dist/antd.min.js"
      crossorigin="anonymous"
      onload="checkResource('Ant Design Vue')"
      onerror="resourceError('Ant Design Vue', this.src)"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/socket.io-client@4.7.5/dist/socket.io.min.js"
      crossorigin="anonymous"
      onload="checkResource('Socket.IO')"
      onerror="resourceError('Socket.IO', this.src)"
    ></script>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        try {
          if (typeof Vue === "undefined" || typeof antd === "undefined") {
            console.error("Critical dependencies missing:", {
              Vue: typeof Vue,
              antd: typeof antd,
            });
            document.getElementById("loading-error").style.display = "block";
            document.getElementById(
              "loading-error"
            ).innerHTML += `<div>Error: Critical dependencies (Vue or AntD) failed to load.</div>`;
            return;
          }

          const { createApp, ref, computed, onMounted } = Vue;
          const { theme } = antd;

          // Jinja2 预渲染的初始数据
          const INITIAL_DATA = JSON.parse(
            document.getElementById("vue-initial-data")?.textContent || "{}"
          );

          const app = createApp({
            setup() {
              // Dark theme
              const darkTheme = {
                algorithm: theme.darkAlgorithm,
                token: {
                  colorPrimary: "#1668dc",
                  colorBgContainer: "rgba(255, 255, 255, 0.03)",
                  colorBgElevated: "rgba(20, 20, 30, 0.95)",
                  colorBorder: "rgba(255, 255, 255, 0.1)",
                  borderRadius: 12,
                },
              };

              // State
              const selectedNav = ref(["dashboard"]);
              const lcuConnected = ref(INITIAL_DATA.lcuConnected);
              const summonerName = ref(INITIAL_DATA.summonerName);
              const recentGames = ref(INITIAL_DATA.recentGames);
              const searchName = ref("");
              const realtimeStatus = ref("等待指令...");

              // Automation
              const autoAcceptRunning = ref(false);
              const autoAnalyzeRunning = ref(false);
              const autoBanPickRunning = ref(false);

              // Champion config
              const banChampions = ref([null]);
              const pickChampions = ref([null]);
              const championOptions = ref([]);

              // Analysis
              const teammates = ref([]);
              const enemies = ref([]);

              // Computed
              const activeModulesCount = computed(() => {
                return [
                  autoAcceptRunning.value,
                  autoAnalyzeRunning.value,
                  autoBanPickRunning.value,
                ].filter(Boolean).length;
              });

              // Socket
              let socket = null;

              onMounted(async () => {
                // Hide loading overlay
                const overlay = document.getElementById("loading-overlay");
                if (overlay) {
                  overlay.style.opacity = "0";
                  setTimeout(() => overlay.remove(), 500);
                }

                // Load champions
                try {
                  const res = await fetch("/api/champions");
                  const data = await res.json();
                  championOptions.value = Object.entries(data).map(
                    ([id, name]) => ({ value: parseInt(id), label: name })
                  );
                } catch (e) {
                  console.error("Failed to load champions:", e);
                }

                // Load preferences
                loadPreferences();

                // WebSocket
                socket = io();
                socket.on("connect", () => console.log("WebSocket connected"));
                socket.on("status_update", (data) => {
                  const msg = data.message || data.data || "";
                  if (msg.includes("成功")) lcuConnected.value = true;
                  else if (msg.includes("失败") || msg.includes("断开"))
                    lcuConnected.value = false;
                  realtimeStatus.value = msg;
                });
                socket.on("enemies_found", (data) => {
                  enemies.value = data.enemies.map((e) => ({
                    ...e,
                    stats: "Loading...",
                  }));
                  realtimeStatus.value = `发现 ${data.enemies.length} 名敌人!`;
                  data.enemies.forEach(async (enemy, idx) => {
                    enemies.value[idx].stats = await fetchStats(
                      enemy.gameName,
                      enemy.tagLine
                    );
                  });
                });
                socket.on("teammates_found", (data) => {
                  teammates.value = data.teammates.map((tm) => ({
                    ...tm,
                    stats: "Loading...",
                  }));
                  realtimeStatus.value = `发现 ${data.teammates.length} 名队友!`;
                  data.teammates.forEach(async (tm, idx) => {
                    teammates.value[idx].stats = await fetchStats(
                      tm.gameName,
                      tm.tagLine
                    );
                  });
                });
              });

              const searchSummoner = () => {
                if (!searchName.value.trim()) {
                  antd.message.warning("请输入召唤师名称");
                  return;
                }
                window.open(
                  `/summoner/${encodeURIComponent(searchName.value)}`,
                  "_blank"
                );
              };

              const searchTFT = () => {
                if (!searchName.value.trim()) {
                  antd.message.warning("请输入召唤师名称");
                  return;
                }
                window.open(
                  `/tft_summoner/${encodeURIComponent(searchName.value)}`,
                  "_blank"
                );
              };

              const toggleAutoAccept = () => {
                if (!lcuConnected.value) {
                  antd.message.error("请先连接到 LCU");
                  return;
                }
                autoAcceptRunning.value = !autoAcceptRunning.value;
                socket.emit(
                  autoAcceptRunning.value
                    ? "start_auto_accept"
                    : "stop_auto_accept"
                );
                antd.message.info(
                  autoAcceptRunning.value ? "自动接受已启动" : "自动接受已停止"
                );
                savePreferences();
              };

              const toggleAutoAnalyze = () => {
                if (!lcuConnected.value) {
                  antd.message.error("请先连接到 LCU");
                  return;
                }
                autoAnalyzeRunning.value = !autoAnalyzeRunning.value;
                socket.emit(
                  autoAnalyzeRunning.value
                    ? "start_auto_analyze"
                    : "stop_auto_analyze"
                );
                antd.message.info(
                  autoAnalyzeRunning.value ? "敌我分析已启动" : "敌我分析已停止"
                );
                savePreferences();
              };

              const toggleAutoBanPick = () => {
                if (!lcuConnected.value) {
                  antd.message.error("请先连接到 LCU");
                  return;
                }
                autoBanPickRunning.value = !autoBanPickRunning.value;
                if (autoBanPickRunning.value) {
                  socket.emit("start_auto_banpick", {
                    ban_champion_id: banChampions.value[0],
                    pick_champion_id: pickChampions.value[0],
                    ban_candidates: banChampions.value.filter(Boolean),
                    pick_candidates: pickChampions.value.filter(Boolean),
                  });
                } else {
                  socket.emit("stop_auto_banpick");
                }
                antd.message.info(
                  autoBanPickRunning.value
                    ? "自动Ban/Pick已启动"
                    : "自动Ban/Pick已停止"
                );
                savePreferences();
              };

              const addBanSlot = () => banChampions.value.push(null);
              const addPickSlot = () => pickChampions.value.push(null);
              const filterChampion = (input, option) =>
                option.label.toLowerCase().includes(input.toLowerCase());

              const fetchStats = async (gameName, tagLine) => {
                try {
                  const res = await fetch(
                    `/api/summoner_stats/${encodeURIComponent(
                      gameName
                    )}/${encodeURIComponent(tagLine)}`
                  );
                  const data = await res.json();
                  if (data.error) return "Stats unavailable";
                  return `${data.wins}W ${data.losses}L (${data.winrate}% WR)`;
                } catch {
                  return "Stats unavailable";
                }
              };

              const savePreferences = () => {
                try {
                  localStorage.setItem(
                    "lcu_ui_ban_champions",
                    JSON.stringify(banChampions.value.filter(Boolean))
                  );
                  localStorage.setItem(
                    "lcu_ui_pick_champions",
                    JSON.stringify(pickChampions.value.filter(Boolean))
                  );
                } catch {}
              };

              const loadPreferences = () => {
                try {
                  const bans = JSON.parse(
                    localStorage.getItem("lcu_ui_ban_champions") || "[]"
                  );
                  const picks = JSON.parse(
                    localStorage.getItem("lcu_ui_pick_champions") || "[]"
                  );
                  if (bans.length) banChampions.value = [...bans, null];
                  if (picks.length) pickChampions.value = [...picks, null];
                } catch {}
              };

              return {
                darkTheme,
                selectedNav,
                lcuConnected,
                summonerName,
                recentGames,
                searchName,
                realtimeStatus,
                autoAcceptRunning,
                autoAnalyzeRunning,
                autoBanPickRunning,
                banChampions,
                pickChampions,
                championOptions,
                teammates,
                enemies,
                activeModulesCount,
                navigateTo,
                searchSummoner,
                searchTFT,
                toggleAutoAccept,
                toggleAutoAnalyze,
                toggleAutoBanPick,
                addBanSlot,
                addPickSlot,
                filterChampion,
              };
            },
          });

          app.use(antd);
          app.mount("#app");
        } catch (error) {
          console.error("Vue initialization error:", error);
          if (error && error.loc) {
            console.error("Vue template location:", error.loc);
          }
          // dump a small slice of the template to help pinpoint issues
          try {
            const tpl = document.getElementById("app")?.innerHTML || "";
            console.error("Vue template preview:", tpl.slice(0, 500));
          } catch {}
          document.getElementById("loading-error").style.display = "block";
          document.getElementById("loading-error").innerHTML += `
            <div style="margin-top: 20px;">
              <strong>Vue Initialization Error:</strong><br>
              <small>${error.message || error.toString()}</small><br>
              ${
                error.loc
                  ? `<div>Line: ${error.loc.start?.line}, Column: ${error.loc.start?.column}</div>`
                  : ""
              }
              <pre style="text-align: left; font-size: 10px; margin-top: 10px; overflow-x: auto;">${
                error.stack || "No stack trace available"
              }</pre>
            </div>
          `;
        }
      });
    </script>
  </body>
</html>
