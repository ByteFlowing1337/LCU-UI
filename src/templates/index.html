<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LCU Companion</title>
    <link rel="icon" type="image/x-icon" href="/static/icon.ico" />

    <!-- Ant Design Vue CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/ant-design-vue@4.x/dist/reset.css"
    />
    <!-- Bootstrap Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="/static/css/index.css" />
  </head>
  <body>
    {% raw %}
    <div id="app" v-cloak>
      <a-config-provider :theme="darkTheme">
        <a-layout class="app-container">
          <!-- Sidebar -->
          <a-layout-sider
            :width="80"
            :collapsed="true"
            :trigger="null"
            style="
              position: fixed;
              height: 100vh;
              left: 0;
              top: 0;
              z-index: 100;
            "
          >
            <div style="padding: 20px; text-align: center">
              <i
                class="bi bi-lightning-charge-fill"
                style="font-size: 28px; color: #1668dc"
              ></i>
            </div>
            <a-menu
              v-model:selectedKeys="selectedNav"
              theme="dark"
              mode="inline"
            >
              <a-menu-item key="dashboard" @click="navigateTo('dashboard')">
                <template #icon><i class="bi bi-house-door"></i></template>
              </a-menu-item>
              <a-menu-item key="search" @click="navigateTo('search')">
                <template #icon><i class="bi bi-search"></i></template>
              </a-menu-item>
              <a-menu-item key="automation" @click="navigateTo('automation')">
                <template #icon><i class="bi bi-cpu"></i></template>
              </a-menu-item>
              <a-menu-item key="stats" @click="navigateTo('stats')">
                <template #icon><i class="bi bi-bar-chart"></i></template>
              </a-menu-item>
            </a-menu>
            <div style="flex-grow: 1"></div>
            <a-menu theme="dark" mode="inline" style="margin-top: auto">
              <a-menu-item key="settings">
                <template #icon><i class="bi bi-gear"></i></template>
              </a-menu-item>
            </a-menu>
          </a-layout-sider>

          <!-- Main Content -->
          <a-layout-content class="main-content">
            <!-- Header -->
            <div class="header-section">
              <div>
                <h1
                  style="font-size: 28px; font-weight: 700; margin-bottom: 4px"
                >
                  Dashboard
                </h1>
                <span style="color: var(--text-secondary)"
                  >Welcome back, {{ summonerName }}</span
                >
              </div>
              <div
                :class="['status-indicator', { disconnected: !lcuConnected }]"
              >
                <div class="status-dot"></div>
                <span
                  >{{ lcuConnected ? 'LCU Connected' : 'LCU Disconnected'
                  }}</span
                >
              </div>
            </div>

            <!-- Dashboard Grid -->
            <div class="dashboard-grid">
              <!-- Left Column -->
              <div class="left-column">
                <!-- Search Card -->
                <a-card style="margin-bottom: 20px">
                  <template #title>
                    <i
                      class="bi bi-search"
                      style="margin-right: 8px; color: #1668dc"
                    ></i>
                    Summoner Search
                  </template>
                  <a-input-search
                    v-model:value="searchName"
                    placeholder="Summoner Name#Tag..."
                    enter-button="Search"
                    size="large"
                    @search="searchSummoner"
                    style="margin-bottom: 12px"
                  />
                  <a-button block @click="searchTFT" style="margin-top: 8px">
                    <i class="bi bi-grid-3x3-gap" style="margin-right: 8px"></i>
                    TFT Stats
                  </a-button>
                </a-card>

                <!-- Summoner Overview -->
                <a-card
                  v-if="summonerProfile || profileLoading"
                  style="margin-bottom: 20px"
                >
                  <template #title>
                    <i
                      class="bi bi-person"
                      style="margin-right: 8px; color: #1668dc"
                    ></i>
                    Summoner Overview
                  </template>
                  <a-spin :spinning="profileLoading">
                    <template v-if="summonerProfile">
                      <div class="summoner-overview">
                        <a-avatar :size="64" :src="summonerProfile.iconUrl">
                          <template #icon
                            ><i class="bi bi-person"></i
                          ></template>
                        </a-avatar>
                        <div class="info">
                          <div class="name">
                            {{ summonerProfile.displayName }}
                          </div>
                          <div class="meta">
                            Lv. {{ summonerProfile.level }}
                          </div>
                          <div
                            class="ranks"
                            v-if="summonerProfile.ranks && summonerProfile.ranks.length"
                          >
                            <span
                              v-for="queue in summonerProfile.ranks"
                              :key="queue.queueType"
                              class="rank-pill"
                            >
                              {{ queue.label }} · {{ queue.tier || 'Unranked' }}
                              {{ queue.division || '' }}
                              <span v-if="queue.lp !== undefined">
                                · {{ queue.lp }} LP</span
                              >
                              <span
                                v-if="queue.wins !== null && queue.losses !== null"
                              >
                                · {{ queue.wins }}W {{ queue.losses }}L</span
                              >
                            </span>
                          </div>
                        </div>
                      </div>

                      <div
                        class="match-list"
                        v-if="summonerHistory && summonerHistory.length"
                      >
                        <div
                          class="match-row"
                          v-for="(game, idx) in summonerHistory"
                          :key="idx"
                        >
                          <span
                            :class="['result-pill', game.result === 'Win' ? 'win' : 'loss']"
                            >{{ game.result || 'N/A' }}</span
                          >
                          <span class="queue">{{ game.queue }}</span>
                          <span class="kda"
                            >KDA {{ game.kills }}/{{ game.deaths }}/{{
                            game.assists }}</span
                          >
                          <span class="time"
                            >{{ game.gameCreation | timeAgo }}</span
                          >
                        </div>
                      </div>
                      <a-empty v-else description="No recent games" />
                    </template>
                    <template v-else-if="profileError">
                      <a-alert type="error" :message="profileError" show-icon />
                    </template>
                  </a-spin>
                </a-card>

                <!-- Recent Activity -->
                <a-card>
                  <template #title>
                    <i
                      class="bi bi-activity"
                      style="margin-right: 8px; color: #1668dc"
                    ></i>
                    Recent Activity
                  </template>
                  <template v-if="lcuConnected && recentGames.length > 0">
                    <div
                      v-for="(game, idx) in recentGames"
                      :key="idx"
                      class="activity-item"
                    >
                      <span
                        :class="game.win ? 'victory-badge' : 'defeat-badge'"
                      >
                        {{ game.win ? 'Victory' : 'Defeat' }}
                      </span>
                      <div>
                        <div
                          style="font-weight: 600; color: var(--text-primary)"
                        >
                          {{ game.queue_name }}
                        </div>
                        <div
                          style="font-size: 12px; color: var(--text-secondary)"
                        >
                          {{ game.time_ago }}
                        </div>
                      </div>
                    </div>
                  </template>
                  <a-empty
                    v-else-if="lcuConnected"
                    description="No recent games found"
                  ></a-empty>
                  <a-empty v-else description="Connect to LCU to view activity">
                    <template #image>
                      <i
                        class="bi bi-wifi-off"
                        style="font-size: 48px; color: var(--text-secondary)"
                      ></i>
                    </template>
                  </a-empty>
                </a-card>
              </div>

              <!-- Right Column -->
              <div class="right-column">
                <!-- Automation Hub -->
                <a-card style="margin-bottom: 20px">
                  <template #title>
                    <div
                      style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                      "
                    >
                      <span>
                        <i
                          class="bi bi-lightning-charge"
                          style="margin-right: 8px; color: #faad14"
                        ></i>
                        Automation Hub
                      </span>
                      <a-tag color="blue"
                        >{{ activeModulesCount }} Active</a-tag
                      >
                    </div>
                  </template>

                  <div class="module-grid">
                    <!-- Auto Accept -->
                    <div
                      :class="['module-card', { active: autoAcceptRunning }]"
                      @click="toggleAutoAccept"
                    >
                      <i class="bi bi-check-circle icon"></i>
                      <div class="title">Auto Accept</div>
                      <div class="status">
                        {{ autoAcceptRunning ? 'Running' : 'Ready' }}
                      </div>
                      <a-switch
                        :checked="autoAcceptRunning"
                        size="small"
                        style="margin-top: 8px"
                        @click.stop
                      />
                    </div>

                    <!-- Auto Analyze -->
                    <div
                      :class="['module-card', { active: autoAnalyzeRunning }]"
                      @click="toggleAutoAnalyze"
                    >
                      <i class="bi bi-shield-check icon"></i>
                      <div class="title">Analyze Enemy</div>
                      <div class="status">
                        {{ autoAnalyzeRunning ? 'Analyzing' : 'Waiting' }}
                      </div>
                      <a-switch
                        :checked="autoAnalyzeRunning"
                        size="small"
                        style="margin-top: 8px"
                        @click.stop
                      />
                    </div>

                    <!-- Auto Ban/Pick -->
                    <div
                      :class="['module-card', { active: autoBanPickRunning }]"
                      @click="toggleAutoBanPick"
                    >
                      <i class="bi bi-tools icon"></i>
                      <div class="title">Auto Ban/Pick</div>
                      <div class="status">
                        {{ autoBanPickRunning ? 'Active' : 'Configured' }}
                      </div>
                      <a-switch
                        :checked="autoBanPickRunning"
                        size="small"
                        style="margin-top: 8px"
                        @click.stop
                      />
                    </div>
                  </div>

                  <!-- Ban/Pick Config -->
                  <a-collapse ghost>
                    <a-collapse-panel key="1" header="Ban/Pick Configuration">
                      <a-row :gutter="16">
                        <a-col :span="12">
                          <div
                            style="
                              margin-bottom: 8px;
                              color: var(--text-secondary);
                              font-size: 12px;
                            "
                          >
                            BAN PRIORITY
                          </div>
                          <a-select
                            v-for="(ban, index) in banChampions"
                            :key="'ban-' + index"
                            v-model:value="banChampions[index]"
                            :options="championOptions"
                            placeholder="Select champion"
                            style="width: 100%; margin-bottom: 8px"
                            show-search
                            :filter-option="filterChampion"
                            allow-clear
                          />
                          <a-button
                            type="dashed"
                            block
                            @click="addBanSlot"
                            size="small"
                          >
                            <i class="bi bi-plus"></i> Add Ban
                          </a-button>
                        </a-col>
                        <a-col :span="12">
                          <div
                            style="
                              margin-bottom: 8px;
                              color: var(--text-secondary);
                              font-size: 12px;
                            "
                          >
                            PICK PRIORITY
                          </div>
                          <a-select
                            v-for="(pick, index) in pickChampions"
                            :key="'pick-' + index"
                            v-model:value="pickChampions[index]"
                            :options="championOptions"
                            placeholder="Select champion"
                            style="width: 100%; margin-bottom: 8px"
                            show-search
                            :filter-option="filterChampion"
                            allow-clear
                          />
                          <a-button
                            type="dashed"
                            block
                            @click="addPickSlot"
                            size="small"
                          >
                            <i class="bi bi-plus"></i> Add Pick
                          </a-button>
                        </a-col>
                      </a-row>
                    </a-collapse-panel>
                  </a-collapse>
                </a-card>

                <!-- Analysis Cards -->
                <div class="analysis-grid">
                  <div class="analysis-card">
                    <div class="header">
                      <i
                        class="bi bi-shield-fill icon"
                        style="color: #1668dc"
                      ></i>
                      <div>
                        <div style="font-weight: 600">Teammate Analysis</div>
                        <div
                          style="font-size: 12px; color: var(--text-secondary)"
                        >
                          View detailed stats
                        </div>
                      </div>
                    </div>
                    <a-empty
                      v-if="teammates.length === 0"
                      description="Waiting for game..."
                      :image-style="{ height: '40px' }"
                    ></a-empty>
                    <div v-else>
                      <div
                        v-for="tm in teammates"
                        :key="tm.puuid"
                        class="activity-item"
                      >
                        <a-avatar
                          :src="getChampionIcon(tm.championId)"
                          style="background-color: #1668dc"
                        >
                          <template #icon
                            ><i class="bi bi-person"></i
                          ></template>
                        </a-avatar>
                        <div style="flex: 1">
                          <a
                            :href="'/summoner/' + encodeURIComponent(tm.gameName + '#' + tm.tagLine)"
                            target="_blank"
                            style="color: #1668dc; font-weight: 600"
                          >
                            {{ tm.gameName }}#{{ tm.tagLine }}
                          </a>
                          <div class="stat-line">
                            <span>{{ tm.stats?.summary || 'Loading...' }}</span>
                            <span v-if="tm.stats?.kda" class="kda-pill"
                              >KDA {{ tm.stats.kda }}</span
                            >
                            <span
                              v-if="tm.stats?.streakType"
                              :class="['streak-pill', tm.stats.streakType === 'W' ? 'streak-win' : 'streak-loss']"
                            >
                              {{ tm.stats.streakType === 'W' ? '连胜' : '连败'
                              }} x{{ tm.stats.streakCount }}
                            </span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="analysis-card">
                    <div class="header">
                      <i
                        class="bi bi-crosshair icon"
                        style="color: #ff4d4f"
                      ></i>
                      <div>
                        <div style="font-weight: 600">Enemy Analysis</div>
                        <div
                          style="font-size: 12px; color: var(--text-secondary)"
                        >
                          Identify threats
                        </div>
                      </div>
                    </div>
                    <a-empty
                      v-if="enemies.length === 0"
                      description="Waiting for game..."
                      :image-style="{ height: '40px' }"
                    ></a-empty>
                    <div v-else>
                      <div
                        v-for="enemy in enemies"
                        :key="enemy.puuid"
                        class="activity-item"
                      >
                        <a-avatar
                          :src="getChampionIcon(enemy.championId)"
                          style="background-color: #ff4d4f"
                        >
                          <template #icon
                            ><i class="bi bi-person"></i
                          ></template>
                        </a-avatar>
                        <div style="flex: 1">
                          <a
                            :href="'/summoner/' + encodeURIComponent(enemy.gameName + '#' + enemy.tagLine)"
                            target="_blank"
                            style="color: #ff4d4f; font-weight: 600"
                          >
                            {{ enemy.gameName }}#{{ enemy.tagLine }}
                          </a>
                          <div class="stat-line">
                            <span
                              >{{ enemy.stats?.summary || 'Loading...' }}</span
                            >
                            <span v-if="enemy.stats?.kda" class="kda-pill"
                              >KDA {{ enemy.stats.kda }}</span
                            >
                            <span
                              v-if="enemy.stats?.streakType"
                              :class="['streak-pill', enemy.stats.streakType === 'W' ? 'streak-win' : 'streak-loss']"
                            >
                              {{ enemy.stats.streakType === 'W' ? '连胜' :
                              '连败' }} x{{ enemy.stats.streakCount }}
                            </span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </a-layout-content>
        </a-layout>
      </a-config-provider>
    </div>
    {% endraw %}

    <!-- Loading Overlay -->
    <div
      id="loading-overlay"
      style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #0a0a0f;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        color: white;
        transition: opacity 0.5s;
      "
    >
      <div style="font-size: 24px; margin-bottom: 20px">
        Loading LCU Companion...
      </div>
      <div
        class="spinner-border text-primary"
        role="status"
        style="width: 3rem; height: 3rem"
      >
        <span class="visually-hidden">Loading...</span>
      </div>
      <div
        id="loading-error"
        style="
          margin-top: 20px;
          color: #ff4d4f;
          display: none;
          text-align: center;
          max-width: 80%;
        "
      ></div>
      <div
        id="loading-debug"
        style="
          margin-top: 10px;
          color: #666;
          font-family: monospace;
          font-size: 12px;
        "
      ></div>
    </div>

    <script id="vue-initial-data" type="application/json">
      {{ initial_vue_data | tojson | safe }}
    </script>

    <script>
      // Inline bootstrap check to verify JS executes
      console.log("✅ Inline bootstrap script executed");
    </script>

    <!-- Error Handling & Resource Loading -->
    <script>
      window.loadErrors = [];
      window.onerror = function (msg, url, line, col, error) {
        console.error("Global Error:", msg, url, line, col, error);
        window.loadErrors.push({ msg, url, line, col, error });
        document.getElementById("loading-error").style.display = "block";
        document.getElementById(
          "loading-error"
        ).innerHTML += `<div>Error: ${msg}</div>`;
      };

      function checkResource(name) {
        document.getElementById(
          "loading-debug"
        ).innerHTML += `<div>Loaded ${name}</div>`;
      }

      function resourceError(name, url) {
        console.error(`Failed to load ${name} from ${url}`);
        document.getElementById("loading-error").style.display = "block";
        document.getElementById("loading-error").innerHTML += `
                <div style="margin-bottom: 10px;">
                    <strong>Failed to load ${name}</strong><br>
                    <small>${url}</small><br>
                    Please check your internet connection or try refreshing.
                </div>
            `;
      }
    </script>

    <!-- Vue 3 + Ant Design Vue -->
    <script
      src="https://cdn.jsdelivr.net/npm/vue@3.4/dist/vue.global.prod.js"
      crossorigin="anonymous"
      onload="checkResource('Vue')"
      onerror="resourceError('Vue', this.src)"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/dayjs@1.11/dayjs.min.js"
      crossorigin="anonymous"
      onload="checkResource('Dayjs')"
      onerror="resourceError('Dayjs', this.src)"
    ></script>

    <!-- Day.js Plugins -->
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11/plugin/customParseFormat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11/plugin/weekday.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11/plugin/localeData.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11/plugin/weekOfYear.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11/plugin/weekYear.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11/plugin/advancedFormat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11/plugin/quarterOfYear.js"></script>

    <script>
      // Initialize Day.js plugins
      if (window.dayjs) {
        dayjs.extend(window.dayjs_plugin_customParseFormat);
        dayjs.extend(window.dayjs_plugin_weekday);
        dayjs.extend(window.dayjs_plugin_localeData);
        dayjs.extend(window.dayjs_plugin_weekOfYear);
        dayjs.extend(window.dayjs_plugin_weekYear);
        dayjs.extend(window.dayjs_plugin_advancedFormat);
        dayjs.extend(window.dayjs_plugin_quarterOfYear);
      }
    </script>

    <script
      src="https://cdn.jsdelivr.net/npm/ant-design-vue@4.x/dist/antd.min.js"
      crossorigin="anonymous"
      onload="checkResource('Ant Design Vue')"
      onerror="resourceError('Ant Design Vue', this.src)"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/socket.io-client@4.7.5/dist/socket.io.min.js"
      crossorigin="anonymous"
      onload="checkResource('Socket.IO')"
      onerror="resourceError('Socket.IO', this.src)"
    ></script>

    <script type="module" src="/static/js/index-vue.js"></script>
  </body>
</html>
